
const snowflake = require('snowflake-sdk');
const logger = require('../config/logger.js');

const snowflakeDBConnection = async (dboptions) => {
  const snowConnectionObj = snowflake.createConnection(dboptions);
  const connectionObj = await new Promise((resolve, reject) => snowConnectionObj.connect(
    (error, response) => {
      if (error) {
        logger.log('error', `(Repository/snowflakeC360.snowflakeDBConnection) # Unable to Connect to SNOWFLAKE DB : ${JSON.stringify(error)}`);
        return reject(error);
      }
      logger.log('info', `(Repository/snowflakeC360.snowflakeDBConnection) # Connected to SNOWFLAKE DB !!: ${JSON.stringify(response)}`);
      return resolve(response);
    }
  ));
  return connectionObj;
};

const getCounts = (processDate, snowConnection) => new Promise((resolve, reject) => {
  snowConnection.execute({
    sqlText: `
                SELECT 'MAB_DEMO' CATEGORY,COUNT(*) TOTALCOUNTS
                FROM DATASCIENCE.DSC.MAB_RUN_3
		WHERE EXTERNAL_ID IN
                (
1789296073,178929636,1789296433,1789297349,1789297406,178929801,17892981,1789298235,1789298531,1789299048,1789299245,1789299517,1789299559,1789300425,1789300754,178930205,1789302099,178930326,1789303263,17893033,1789304099,1789304147,1789304294,1789304833,1789305224,1789305830,1789307344,17893075,1789307579,1789308152,1789308318,178930853,178930884,178930885,1789309016,1789309066,1789309210,1789309493,1789309516,1789309947,1789310869,17893115,1789311622,178931171,1789312,17893122,17893128,1789312812,1789313181,178931334,1864201674,186420172,1864201746,1864201774,1864201797,1864201879,1864201996,1864202006,1864202018,1864202045,1864202154,1864202293,1864202331,1864202362,1864202389,1864202415,1864202453,1864202470,1864202519,1864202664,1864202671,1864202710,1864202735,1864202788,1864202833,1864202852,1864202856,1864202987,1864203006,186420309,1864203239,1864203271,1864203289,1864203307,1864203325,1864203433,1864203621,1864203625,1864203736,1864203765,1864203833,1864203903,1864203924,1864203938,1864203958,1864203973,1864203980,1864204049,1864204060,186420407,1864267216,1864267221,1864267229,1864267268,1864267336,1864267362,1864267398,1864267466,1864267488,1864267501,1864267521,1864267541,1864267746,1864267831,1864267882,1864267893,1864267966,1864268060,1864268120,1864268163,1864268273,1864268300,1864268308,1864268324,1864268338,1864268477,1864268566,1864268677,1864268685,1864268732,1864268767,1864268819,1864268846,1864268930,1864268940,1864268941,1864268980,1864268999,1864269113,1864269124,1864269208,1864269312,1864269369,1864269383,1864269422,1864269557,1864269608,1864269645,1864269666,1864269677,1864168664,1864168883,1864168954,1864168963,1864168970,1864169069,1864169135,1864169137,1864169160,1864169226,186416926,1864169366,1864169454,1864169464,1864169549,1864169568,1864169569,1864169588,1864169617,1864169685,1864169730,1864169785,1864169914,1864169940,1864169979,1864170009,1864170068,1864170103,1864170196,1864170295,1864170393,1864170406,1864170430,1864170442,1864170515,1864170530,1864170704,1864170751,1864170760,1864170847,1864170870,1864170923,1864170982,1864170996,1864171010,1864171026,1864171049,1864171124,1864171183,1864171244,1864212384,1864212491,1864212568,1864212586,1864212594,1864212611,1864212791,1864212792,1864212833,1864212878,1864212879,1864212962,1864213016,1864213032,1864213124,1864213140,1864213223,1864213230,1864213250,1864213264,1864213296,1864213352,1864213464,1864213514,1864213525,1864213530,1864213555,1864213844,1864213951,1864213982,1864214030,1864214157,1864214243,1864214249,1864214276,186421429,1864214316,1864214363,1864214547,1864214550,1864214555,1864214579,1864214629,1864214678,1864214681,1864214700,1864214836,1864214849,1864214850,1864214892,1864394256,1864394356,1864394359,1864394400,1864394466,1864394472,1864394493,1864394692,1864394746,1864394815,1864394844,1864394857,1864394866,1864394884,1864394971,1864395030,1864395038,1864395122,1864395198,1864395402,1864395453,1864395500,1864395740,1864395765,1864395859,1864395863,1864395897,1864395917,1864395932,1864396023,1864396077,1864396101,1864396109,1864396446,1864396459,1864396510,1864396534,1864396547,1864396552,1864396655,1864396705,1864396739,186439683,1864396833,1864396913,1864396958,1864396985,1864397008,1864397121,1864397217,1864243294,1864243334,1864243360,1864243368,1864243396,1864243446,1864243523,1864243537,1864243581,1864243626,1864243727,1864243771,1864243799,1864243817,1864243884,1864243886,1864243954,1864243975,1864243989,1864244038,1864244162,1864244234,1864244274,1864244303,1864244355,1864244366,1864244383,1864244407,1864244452,1864244473,1864244514,1864244597,1864244681,1864244718,1864244740,1864244805,1864244868,1864244888,1864244914,1864244956,1864244958,1864244969,1864244995,1864245007,186424504,1864245101,1864245115,1864245202,1864245223,1864245287,237093329,2370933346,2370933403,2370933528,237093357,2370933672,2370933877,2370934001,2370934245,2370934459,2370934869,2370935650,2370937066,2370937124,2370937355,2370937564,237093776,237093841,237093894,2370939369,237093949,2370939690,2370939830,2370939951,237094003,2370940349,237094071,2370940979,237094123,2370941331,237094135,237094138,2370941995,237094206,23709426,237094281,2370943024,2370943209,2370943221,2370943307,2370943339,2370944192,237094420,2370944238,2370944275,237094436,2370944527,2370944901,2370944942,237094533,2544399799,2544399801,2544399804,2544399809,2544399828,2544399851,2544399867,2544399870,2544399885,2544399903,2544399936,2544399943,2544399960,254440,2544400004,2544400005,2544400033,2544400063,2544400089,2544400119,2544400125,2544400130,2544400137,2544400139,2544400157,2544400158,2544400220,2544400272,2544400274,2544400324,2544400328,2544400344,2544400392,2544400396,2544400405,2544400406,2544400413,2544400420,2544400433,2544400436,2544400451,2544400481,2544400509,2544400522,2544400531,2544400551,254440056,2544400578,2544400629,2544400631,28827165,288271935,288271937,288271949,28827198,288272036,288272590,28827262,288272630,288272816,288273118,288273128,288273149,28827339,28827344,288273813,288273839,288273904,28827394,288273963,288274027,28827403,288274130,288274194,288274300,288274490,288275098,288275254,288275314,28827533,288275407,288275543,288275606,288275751,288276,2882761,288276483,2882767,288276769,288276840,288277408,288277482,28827755,2882776,2882777,288277781,28827786,288278319,288278464,288278524,320411448,320411476,320411614,3204118,320411806,32041200,320412468,32041248,32041252,320412673,32041279,320412935,320412950,320413,32041300,320413060,320413099,320413361,32041362,320413659,320414167,320414620,32041475,320414878,320414882,32041494,320415019,320415092,3204152,320415251,320415360,320415378,320415446,32041569,320416066,32041620,320416351,32041663,320416717,320416872,320417,320417123,320417379,320417455,32041757,320417815,32041789,32041791,320418049,32041811,550700714,550700715,550700746,550700770,550700787,550700791,550700796,550700814,550700842,550701170,550701171,550701195,550701249,550701286,55070129,550701344,550701375,550701613,550701640,550701684,550701690,550701721,550701749,550701810,550701829,5507019,550701928,550701951,550701976,550702006,550702026,550702082,550702102,550702107,550702171,550702204,550702245,550702380,550702383,550702397,550702497,550702579,550702601,550702654,55070271,550702772,5507028,550702830,550702849,550702853,702618309,702618361,702618520,702618568,702618733,70261932,702619386,70261967,702619690,702619828,702619847,702619943,702619947,70261997,702620191,702620223,702620362,702620601,70262089,702621090,702621146,702621176,702621357,702621500,702621607,702621892,702622246,702622699,7026228,702622905,702623042,70262306,702623236,70262333,702623409,70262351,702623557,702623854,702623901,702623916,702624084,702624281,702624310,702624731,702624733,702624774,702625165,702625491,70262550,702625743,867756192,867756278,867756329,867756415,867756480,867756591,867756664,867756849,867756862,867756871,867756880,867756907,867756908,867756934,86775701,867757063,867757165,867757289,867757320,867757367,867757382,867757396,867757402,867757423,867757513,867757529,867757617,867757624,867757649,867757725,867757756,867757790,867757801,867757911,86775837,86775840,867758415,867758503,867758522,867758596,867758608,867758631,867758643,867758787,867758855,867758927,867758937,867758949,867759045,867759166,967412005,96741217,967412331,96741239,967412571,967412693,967412842,967413017,967413077,967413462,967413783,96741381,967413892,967413918,967413946,967413966,967414087,967414103,967414120,967414162,967414343,967414417,967414653,967414926,967414973,967415277,967415358,967415690,967415979,96741599,967416105,967416258,967416698,967416760,967417118,967417204,967417223,967417324,967417526,967417572,967417678,967417699,967417775,96741783,967417869,96741789,96741806,9674184,967418432,967418918)
      `,
    complete: (error, stmt, rows) => {
      if (error) {
        logger.log('error', `(Repository/snowflakeC360.getCounts) # Unable to execute query on SNOWFLAKE DB`);
        reject(error);
      } else {
        logger.log('info', `(Repository/snowflakeC360.getCounts) # executed query on SNOWFLAKE DB ${JSON.stringify(rows)} `);
        resolve(rows);
      }
    }
  });
});
const fetchHomeStoreUpdates = (processDate, snowConnection, offset, batchSize) => new Promise(
  (resolve, reject) => {
    snowConnection.execute({
      sqlText: `
                SELECT EXTERNAL_ID, TREATMENT, OPT_OUT_FLAG, FLASH, OFFER_A, OFFER_B, OFFER_C, OFFER_D, OFFER_E, OFFER_F, OFFER_G
                FROM DATASCIENCE.DSC.MAB_RUN_3
                WHERE EXTERNAL_ID IN
		(
1789296073,178929636,1789296433,1789297349,1789297406,178929801,17892981,1789298235,1789298531,1789299048,1789299245,1789299517,1789299559,1789300425,1789300754,178930205,1789302099,178930326,1789303263,17893033,1789304099,1789304147,1789304294,1789304833,1789305224,1789305830,1789307344,17893075,1789307579,1789308152,1789308318,178930853,178930884,178930885,1789309016,1789309066,1789309210,1789309493,1789309516,1789309947,1789310869,17893115,1789311622,178931171,1789312,17893122,17893128,1789312812,1789313181,178931334,1864201674,186420172,1864201746,1864201774,1864201797,1864201879,1864201996,1864202006,1864202018,1864202045,1864202154,1864202293,1864202331,1864202362,1864202389,1864202415,1864202453,1864202470,1864202519,1864202664,1864202671,1864202710,1864202735,1864202788,1864202833,1864202852,1864202856,1864202987,1864203006,186420309,1864203239,1864203271,1864203289,1864203307,1864203325,1864203433,1864203621,1864203625,1864203736,1864203765,1864203833,1864203903,1864203924,1864203938,1864203958,1864203973,1864203980,1864204049,1864204060,186420407,1864267216,1864267221,1864267229,1864267268,1864267336,1864267362,1864267398,1864267466,1864267488,1864267501,1864267521,1864267541,1864267746,1864267831,1864267882,1864267893,1864267966,1864268060,1864268120,1864268163,1864268273,1864268300,1864268308,1864268324,1864268338,1864268477,1864268566,1864268677,1864268685,1864268732,1864268767,1864268819,1864268846,1864268930,1864268940,1864268941,1864268980,1864268999,1864269113,1864269124,1864269208,1864269312,1864269369,1864269383,1864269422,1864269557,1864269608,1864269645,1864269666,1864269677,1864168664,1864168883,1864168954,1864168963,1864168970,1864169069,1864169135,1864169137,1864169160,1864169226,186416926,1864169366,1864169454,1864169464,1864169549,1864169568,1864169569,1864169588,1864169617,1864169685,1864169730,1864169785,1864169914,1864169940,1864169979,1864170009,1864170068,1864170103,1864170196,1864170295,1864170393,1864170406,1864170430,1864170442,1864170515,1864170530,1864170704,1864170751,1864170760,1864170847,1864170870,1864170923,1864170982,1864170996,1864171010,1864171026,1864171049,1864171124,1864171183,1864171244,1864212384,1864212491,1864212568,1864212586,1864212594,1864212611,1864212791,1864212792,1864212833,1864212878,1864212879,1864212962,1864213016,1864213032,1864213124,1864213140,1864213223,1864213230,1864213250,1864213264,1864213296,1864213352,1864213464,1864213514,1864213525,1864213530,1864213555,1864213844,1864213951,1864213982,1864214030,1864214157,1864214243,1864214249,1864214276,186421429,1864214316,1864214363,1864214547,1864214550,1864214555,1864214579,1864214629,1864214678,1864214681,1864214700,1864214836,1864214849,1864214850,1864214892,1864394256,1864394356,1864394359,1864394400,1864394466,1864394472,1864394493,1864394692,1864394746,1864394815,1864394844,1864394857,1864394866,1864394884,1864394971,1864395030,1864395038,1864395122,1864395198,1864395402,1864395453,1864395500,1864395740,1864395765,1864395859,1864395863,1864395897,1864395917,1864395932,1864396023,1864396077,1864396101,1864396109,1864396446,1864396459,1864396510,1864396534,1864396547,1864396552,1864396655,1864396705,1864396739,186439683,1864396833,1864396913,1864396958,1864396985,1864397008,1864397121,1864397217,1864243294,1864243334,1864243360,1864243368,1864243396,1864243446,1864243523,1864243537,1864243581,1864243626,1864243727,1864243771,1864243799,1864243817,1864243884,1864243886,1864243954,1864243975,1864243989,1864244038,1864244162,1864244234,1864244274,1864244303,1864244355,1864244366,1864244383,1864244407,1864244452,1864244473,1864244514,1864244597,1864244681,1864244718,1864244740,1864244805,1864244868,1864244888,1864244914,1864244956,1864244958,1864244969,1864244995,1864245007,186424504,1864245101,1864245115,1864245202,1864245223,1864245287,237093329,2370933346,2370933403,2370933528,237093357,2370933672,2370933877,2370934001,2370934245,2370934459,2370934869,2370935650,2370937066,2370937124,2370937355,2370937564,237093776,237093841,237093894,2370939369,237093949,2370939690,2370939830,2370939951,237094003,2370940349,237094071,2370940979,237094123,2370941331,237094135,237094138,2370941995,237094206,23709426,237094281,2370943024,2370943209,2370943221,2370943307,2370943339,2370944192,237094420,2370944238,2370944275,237094436,2370944527,2370944901,2370944942,237094533,2544399799,2544399801,2544399804,2544399809,2544399828,2544399851,2544399867,2544399870,2544399885,2544399903,2544399936,2544399943,2544399960,254440,2544400004,2544400005,2544400033,2544400063,2544400089,2544400119,2544400125,2544400130,2544400137,2544400139,2544400157,2544400158,2544400220,2544400272,2544400274,2544400324,2544400328,2544400344,2544400392,2544400396,2544400405,2544400406,2544400413,2544400420,2544400433,2544400436,2544400451,2544400481,2544400509,2544400522,2544400531,2544400551,254440056,2544400578,2544400629,2544400631,28827165,288271935,288271937,288271949,28827198,288272036,288272590,28827262,288272630,288272816,288273118,288273128,288273149,28827339,28827344,288273813,288273839,288273904,28827394,288273963,288274027,28827403,288274130,288274194,288274300,288274490,288275098,288275254,288275314,28827533,288275407,288275543,288275606,288275751,288276,2882761,288276483,2882767,288276769,288276840,288277408,288277482,28827755,2882776,2882777,288277781,28827786,288278319,288278464,288278524,320411448,320411476,320411614,3204118,320411806,32041200,320412468,32041248,32041252,320412673,32041279,320412935,320412950,320413,32041300,320413060,320413099,320413361,32041362,320413659,320414167,320414620,32041475,320414878,320414882,32041494,320415019,320415092,3204152,320415251,320415360,320415378,320415446,32041569,320416066,32041620,320416351,32041663,320416717,320416872,320417,320417123,320417379,320417455,32041757,320417815,32041789,32041791,320418049,32041811,550700714,550700715,550700746,550700770,550700787,550700791,550700796,550700814,550700842,550701170,550701171,550701195,550701249,550701286,55070129,550701344,550701375,550701613,550701640,550701684,550701690,550701721,550701749,550701810,550701829,5507019,550701928,550701951,550701976,550702006,550702026,550702082,550702102,550702107,550702171,550702204,550702245,550702380,550702383,550702397,550702497,550702579,550702601,550702654,55070271,550702772,5507028,550702830,550702849,550702853,702618309,702618361,702618520,702618568,702618733,70261932,702619386,70261967,702619690,702619828,702619847,702619943,702619947,70261997,702620191,702620223,702620362,702620601,70262089,702621090,702621146,702621176,702621357,702621500,702621607,702621892,702622246,702622699,7026228,702622905,702623042,70262306,702623236,70262333,702623409,70262351,702623557,702623854,702623901,702623916,702624084,702624281,702624310,702624731,702624733,702624774,702625165,702625491,70262550,702625743,867756192,867756278,867756329,867756415,867756480,867756591,867756664,867756849,867756862,867756871,867756880,867756907,867756908,867756934,86775701,867757063,867757165,867757289,867757320,867757367,867757382,867757396,867757402,867757423,867757513,867757529,867757617,867757624,867757649,867757725,867757756,867757790,867757801,867757911,86775837,86775840,867758415,867758503,867758522,867758596,867758608,867758631,867758643,867758787,867758855,867758927,867758937,867758949,867759045,867759166,967412005,96741217,967412331,96741239,967412571,967412693,967412842,967413017,967413077,967413462,967413783,96741381,967413892,967413918,967413946,967413966,967414087,967414103,967414120,967414162,967414343,967414417,967414653,967414926,967414973,967415277,967415358,967415690,967415979,96741599,967416105,967416258,967416698,967416760,967417118,967417204,967417223,967417324,967417526,967417572,967417678,967417699,967417775,96741783,967417869,96741789,96741806,9674184,967418432,967418918
)
		ORDER BY EXTERNAL_ID
                LIMIT ${batchSize} OFFSET ${offset} 
            `,
      complete: (error, stmt, rows) => {
        if (error) {
          logger.log('error', `(Repository/snowflakeC360.fetchHomeStoreUpdates) # Unable to execute query on SNOWFLAKE DB`);
          reject(error);
        } else {
          logger.log('info', `(Repository/snowflakeC360.fetchHomeStoreUpdates) # executed query on SNOWFLAKE DB`);
          resolve(rows);
        }
      }
    });
  }
);
module.exports = {
  snowflakeDBConnection,
  getCounts,
  fetchHomeStoreUpdates
};
